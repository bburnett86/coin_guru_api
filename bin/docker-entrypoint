#!/bin/bash -e

# Enable jemalloc if available
[ -f /usr/lib/*/libjemalloc.so.2 ] && export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"

# Ensure proper binstubs
if [ ! -f bin/rails ]; then
  echo "Regenerating binstubs..."
  bundle binstubs railties --force
  chmod +x bin/*
  ln -sf railties bin/rails
fi

# Database initialization
if [ -f bin/rails ]; then
  echo "Checking database connectivity for ${RAILS_ENV} environment..."
  
  # Wait for PostgreSQL
  until PGPASSWORD=$DATABASE_PASSWORD psql -h "$DATABASE_HOST" -U "$DATABASE_USERNAME" -d postgres -c '\q'; do
    echo "Waiting for database server..."
    sleep 2
  done

  # Create database if needed
  if ! PGPASSWORD=$DATABASE_PASSWORD psql -h "$DATABASE_HOST" -U "$DATABASE_USERNAME" -lqt | cut -d \| -f 1 | grep -qw "$DATABASE_NAME"; then
    echo "Creating database ${DATABASE_NAME}..."
    bundle exec rails db:create
  fi

  # Run migrations
  echo "Running database setup..."
  bundle exec rails db:migrate
fi

exec "$@"
